---
title: "AWS GreenGrass による、簡単でちょっといい感じのIoT機器管理"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["awsiotgreengrass", "aws", "awsiotcore", "iot"]
published: false
---

## 1.はじめに

こんにちは。
私は普段、非IT系の事業会社（いわゆるJTC）にて「部署内DX」の推進役を担っており、現場の手元業務を即座に改善するためのPoCやツール活用をメインに行っております。
PoCの中でよくあるのがRaspberryPiを使ったIoTですが、やっといい感じの運用方法が分かってきたので共有したいと思います

## 2.対象読者

- RaspberryPiを使ったIoT機器の運用を検討している方
- 「とりあえず動く」けど、保守性の運用性の高い設計へステップアップしたい方

## 3.記事を読むメリット

- AWS IoT Greengrassについてざっくり知れる

## 4. 学習の背景
<!-- Greengrassで、プロビジョンを簡素化、OTA機能を簡単に構築 このメリットを最大化できるような前提を記載する -->
これまでIoT機器開発においては、ほとんどの場合で、IoT Coreで"モノ"を作成し１つ１つ手作業でプロビジョンする手段を採用してきました。理由はこだわりではなく、

- アーキテクチャへの知識不足
- 運用数が少ないという

というのが本音です。
また、そもそも運用を見据えた機能が不足していたこともあり、以下の課題に直面することが多々ありました。

- IoT機器に組み込まれたプログラムが把握できない（現場で担当者が暫定対策を施した野良ブランチ）
- プログラムをアップデートするリソースが膨大

## 5.AWS IoT Greengrassとは

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/what-is-iot-greengrass.html

公式では以下のように記されています

> AWS IoT Greengrass は、デバイスで IoT アプリケーションを構築、デプロイ、管理するうえで役立つオープンソースのモノのインターネット (IoT) エッジランタイムとクラウドサービスです。

私が最も恩恵を受けている部分は、課題であったデプロイメントの大変さを解消してくれる点で、OTA（Over the air）を特別な実装無しに構築することができる点です。
その他も色々ありますが完全に把握しきれていません。

## 6.始めかた

管理PC：Windows11
IoT機器：RaspberryPi 4

### 6.1.AWS Greengrassでの初期セットアップ

参照
https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/install-greengrass-v2-console.html

:::message
RaspberryPiがすでに初期セットアップ済みの場合は、RaspberryPiからAWSにアクセスし操作することをお勧めします。
:::

- AWS IoT > Greengrass > コアデバイスへアクセスし、右上の”コアデバイスをセットアップ” > "1つのCoreデバイスをセットアップ" をクリック

![createacoredevice](/images/greengrass/create_a_core_device.png)

- 以下参考に各項目の内容を選択/入力する

| 項目                                             | 入力値                                               | 備考                                                                                                                                                                                                           |
| ------------------------------------------------ | ---------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| コアデバイス名                                   | デバイス固有の名前                                   | 後から識別できる名前を付ける e.g. S/N                                                                                                                                                                          |
| モノのグループ                                   | 初回は新しいグループを作成する                       | 設定やプログラムを適用する単位の識別できる名前を付ける e.g. dev-raspi-g                                                                                                                                        |
| ソフトウェアランタイム                           | Greengrass nucleus                                   | [RaspberryPi Pico](https://akizukidenshi.com/catalog/g/g116132/) くらい小メモリなモノは[liteがよい](https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/greengrass-nucleus-lite-component.html) |
| オペレーティングシステム                         | Linux                                                | 端末に合わせて設定                                                                                                                                                                                             |
| デバイスのセットアップ方法                       | インストーラーのダウンロードでデバイスをセットアップ | 既にRaspberryPiでOSが起動していてセットアップを完了している場合はこちらを選択すると良い                                                                                                                        |
| AWS IoT モノ                                     | クリックする                                     | モノが作成される                                                                                                                                                                                               |
| 接続キットをダウンロード                         | クリックする                                     | 後からダウンロードできないので必須                                                                                                                                                                             |
| インストーラーをダウンロード                     | クリックする                                     | RaspberryPiでGreengrass nucleus ランタイムをインストールするためのファイル一式                                                                                                                                 |
| ダウンロードをデバイスに転送してセットアップする | コードをコピーしておく                               | RaspberryPiで実行するコマンド |

- 作成を完了させる

### 6.2.Edgeデバイス(RaspberryPi)での初期セットアップ

- RaspberryPiでランタイム動作に必要なJavaをインストールする

```sh
sudo apt install -y openjdk-11-jdk
```

- AWSからダウンロードした２つのファイル`接続キット`、`インストーラー`をRaspberryPi内に配置し解凍する
- `接続キット`を `~/GreengrassInstaller`フォルダに配置する
- `インストーラー`を`/greengrass/v2`に配置する（以下の例では解凍時に一時的に`/greengrass-installer-temp`フォルダに配置していたものを移動）

```sh
sudo mkdir /greengrass/v2/
sudo cp -r ~/greengrass-installer-temp/* /greengrass/v2/
```

- `接続キット`を配置したディレクトリ（本例では`~`）に移動しAWSからコピーした下記コマンドを実行する

```sh
sed -i 's|{{config_dir}}|/greengrass/v2|g; s|{{nucleus_component}}|aws.greengrass.Nucleus|g' /greengrass/v2/config.yaml && sudo -E java -Droot="/greengrass/v2" -Dlog.store=FILE -jar ./GreengrassInstaller/lib/Greengrass.jar --init-config /greengrass/v2/config.yaml --component-default-user ggc_user:ggc_group --setup-system-service true
```

- インストールに成功すると最終的に以下のような出力を確認できます

```text
Successfully set up Nucleus as a system service
```

- 同時にAWS IoT Greengrassのコアデバイス画面でも作成したコアデバイスがステータス正常となって表示されるはずです

![canviewcoredevice](/images/greengrass/can_view_core_device.png)

### 6.3.デプロイ