---
title: "AWS GreenGrass による、簡単でちょっといい感じのIoT機器管理"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["awsiotgreengrass", "aws", "awsiotcore", "iot"]
published: false
---

## はじめに

こんにちは。
私は普段、非IT系の事業会社（いわゆるJTC）にて「部署内DX」の推進役を担っており、現場の手元業務を即座に改善するためのPoCやツール活用をメインに行っております。
PoCの中でよくあるのがRaspberryPiを使ったIoTですが、管理できていない野良デバイスが増殖することに頭を悩ませてきました。

## 対象読者

- RaspberryPiを使ったIoT機器の運用を検討している方
- OTA（Over the Air）を簡単に実装したい方
- 「とりあえず動く」けど、保守性の運用性の高い設計へステップアップしたい方

## 記事を読むメリット

- AWS IoT Greengrassについてざっくり知れる

## 学習の背景

職場向けDXを開始したころのIoT機器開発では、１つ１つの`モノ`を手作業でプロビジョンしておりました。理由はこだわりではなく、

- アーキテクチャへの知識不足
- 運用数が少ないという

というのが本音です。
この状況をリアーキテクチャすることなく、関与するPoCが増えても同じ作業方法を繰り返し実施しておりました。
（他責するわけではないですが私自身は出向で職場を離れてしまい関与できませんでした）

### 結果どうなったか

気が付けば、管理できていないデバイスが大量生産されている状況です

- 現場で担当者が暫定対策を施した野良ブランチが出来上がり、現在の実装状況が把握できない
- 現地でデバイス本体に物理的にアクセスしないとプログラムをアップデートできない
- 現在、健康に動作しているかもわからないデバイスも何個かある

![manydevice](/images/greengrass/many_no_management_device.png)

- これが起因して往復700km運転する出張を経験しました

## AWS IoT Greengrassはどんな効果をもたらすか

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/what-is-iot-greengrass.html
https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2024_AWS-IoT-Greengrass-Basic_1106_v1.pdf

Greengrassの全ての機能を理解できていませんが少なからず、Greengrassを活用し以下の恩恵を受けることができました

- OTA(Over The Air)によるリモートアップデートの導入
  - 自前実装無しに安全なアップデートを実現可能
- デプロイフローのクラウド強制によるガバナンス強化
  - 本質的ではないですが野良ブランチを抑制し管理体制を構築できる
- エッジ・クラウド間のパイプラインを自前実装少なく開発できる
  - Log, Telemetry, DeviceShadowといったクラウド同期を最小限の実装コストで実現可能

管理体制はもちろん、実装コストも下げれる部分で大きな恩恵を受けられると思います

## 最小構成のハンズオン

- 開発PC：Windows11
- IoT機器：RaspberryPi 4

:::message
本来は開発側とIoT側は同じ環境を使用するべきです
私の即席環境が単に上記だったというだけです
:::

### AWS Greengrassの初期セットアップ

---

参照ドキュメント

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/install-greengrass-v2-console.html

:::message
RaspberryPiがすでに初期セットアップ済みの場合は、RaspberryPiからAWSにアクセスし操作することをお勧めします。
:::

- AWS IoT > Greengrass > コアデバイスへアクセスし、右上の”コアデバイスをセットアップ” > "1つのCoreデバイスをセットアップ" をクリック

![createacoredevice](/images/greengrass/create_a_core_device.png)

- 以下を参考に各項目を選択/入力する

| 項目                                             | 入力値                                               | 備考                                                                                                                                                                                                           |
| ------------------------------------------------ | ---------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| コアデバイス名                                   | デバイス固有の名前                                   | 後から識別できる名前を付ける e.g. S/N                                                                                                                                                                          |
| モノのグループ                                   | 初回は新しいグループを作成する                       | 設定やプログラムを適用する単位の識別できる名前を付ける e.g. dev-raspi-g                                                                                                                                        |
| ソフトウェアランタイム                           | Greengrass nucleus                                   | [RaspberryPi Pico](https://akizukidenshi.com/catalog/g/g116132/) くらい小メモリなモノは[liteがよい](https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/greengrass-nucleus-lite-component.html) |
| オペレーティングシステム                         | Linux                                                | 端末に合わせて設定                                                                                                                                                                                             |
| デバイスのセットアップ方法                       | インストーラーのダウンロードでデバイスをセットアップ | 既にRaspberryPiでOSが起動していてセットアップを完了している場合はこちらを選択すると良い                                                                                                                        |
| AWS IoT モノ                                     | クリックする                                     | モノが作成される                                                                                                                                                                                               |
| 接続キットをダウンロード                         | クリックする                                     | 後からダウンロードできないので必須                                                                                                                                                                             |
| インストーラーをダウンロード                     | クリックする                                     | RaspberryPiでGreengrass nucleus ランタイムをインストールするためのファイル一式                                                                                                                                 |
| ダウンロードをデバイスに転送してセットアップする | コードをコピーしておく                               | RaspberryPiで実行するコマンド |

- 作成を完了させる

### RaspberryPiの初期セットアップ

---

- RaspberryPiでランタイム動作に必要なJavaをインストールする

```sh
sudo apt install -y openjdk-11-jdk
```

- AWSからダウンロードした２つのファイル`接続キット`、`インストーラー`をRaspberryPi内に配置し解凍する
- `接続キット`を `~/GreengrassInstaller`フォルダに配置する
- `インストーラー`を`/greengrass/v2`に配置する（以下の例では解凍時に一時的に`/greengrass-installer-temp`フォルダに配置していたものを移動）

```sh
sudo mkdir /greengrass/v2/
sudo cp -r ~/greengrass-installer-temp/* /greengrass/v2/
```

- `接続キット`を配置したディレクトリ（本例では`~`）に移動しAWSからコピーした下記コマンドを実行する

```sh
sed -i 's|{{config_dir}}|/greengrass/v2|g; s|{{nucleus_component}}|aws.greengrass.Nucleus|g' /greengrass/v2/config.yaml && sudo -E java -Droot="/greengrass/v2" -Dlog.store=FILE -jar ./GreengrassInstaller/lib/Greengrass.jar --init-config /greengrass/v2/config.yaml --component-default-user ggc_user:ggc_group --setup-system-service true
```

- インストールに成功すると最終的に以下のような出力を確認できます

```text
Successfully set up Nucleus as a system service
```

- 同時にAWS IoT Greengrassのコアデバイス画面でも作成したコアデバイスがステータス正常となって表示されるはずです

![canviewcoredevice](/images/greengrass/can_view_core_device.png)

#### S3バケットとサンプルファイルを作成

バケット構造は以下のような構造を作っておくと良いと思います

```text
bucket
    ├ artifacts
        └ {component name}
            └ {version e.g. 1.0.0}
                └ {your program}
```

[公式ドキュメント](https://docs.aws.amazon.com/greengrass/v2/developerguide/create-first-component.html)を参考に以下のプログラムを`/1.0.0`に配置

```python:hello_world.py
import sys
message = "Hello, %s!" % sys.argv[1]

print(message)
```

### コンポーネントを作成する

---

コンポーネントとは`Recipes`と`Artifacts`から構成される、動作プログラムやデバイス設定等を持つ再利用可能なソフトウエアモジュールのことです

https://docs.aws.amazon.com/greengrass/v2/developerguide/create-first-component.html

作り方はCLIを初め様々な方法があるようですが、GUIで簡単に作る方法で進めます

- AWS IoT > Greengrass > コンポーネントへアクセスしコンポーネントを作成をクリック
- レシピをJSONとして入力しますを選択
- 表示されるサンプルの内L.23を作成したバケット構造に合わせて修正

```json
"URI": "s3://{your bucket name}/artifacts/com.example.HelloWorld/1.0.0/hello_world.py"
```

- コンポーネントの作成をクリックし完成させる

#### 権限付与

- コアデバイスがS3にアクセスしコンポーネントを取得できるための権限を付与します
- いくつか手段はあるようですが、簡単なに作る方法で進めます

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/device-service-role.html

- IAM > ロールにアクセス
- `GreengrassV2CoreDeviceRole`を検索
- 以下の権限を追加付与する
  - `s3:GetBucketLocation`
  - `s3:GetObject`

- 公式ドキュメントでは`GreengrassV2TokenExchangeRole`を使用するよう記述がありますが、少なくとも私の環境では同名の物が存在せず`GreengrassV2CoreDeviceRole`で同じ結果を得られています。
- ご自身の環境を確認しながら進めてください。

### デプロイする

- AWS IoT > Greengrass > デプロイへアクセスし`作成`をクリック

#### 6.5.2.Step1 ターゲットを指定

- デプロイの`名前`を入力する

:::message
１度作成したデプロイオブジェクトは再デプロイする際に、変更/更新して使いまわす運用になります
よって、対象のデプロイターゲット（どんなものか）を識別するような命名が良いと思ってます
:::

- デプロイするコアデバイスもしくはモノのグループを指定する

#### 6.5.3.Step2 コンポーネントの選択

- マイコンポーネントから[6.4.コンポーネントを作成する](#64コンポーネントを作成する)で作成したコンポーネントを選択する e.g. `com.example.HelloWorld`
- パブリックコンポーネントは現時点では使用しない。後述しますがこれを活用し機能実装を簡略化させることができます。

#### 6.5.4.Step3 コンポーネントを設定

- 各コンポーネントに追加設定を行うことができるが、本手順では実施しません

#### 6.5.5.Step4 詳細設定を構成

- 現時点では使用しない。初期設定のままでOK。
<!-- - ロールアウト設定：
- タイムアウト設定：
- キャンセル設定：
- デプロイポリシー： -->

#### 6.5.6.Step5 レビュー

- 問題なければデプロイをクリック

### 動作確認

- RaspberryPiにて作成した`com.example.HelloWorld`が動作しているはずです
- RaspberryPiでの動作確認を行うには以下のコマンドを実行します

```sh
sudo tail -f /greengrass/v2/logs/{component name}.log
# 入力例 sudo tail -f /greengrass/v2/logs/com.example.HelloWorld.log
# 出力例 Hello, world!
```

## 実践編

- ここまでの内容でデプロイメントをリモート実行（OTA）できることを体験いただけたと思います
- ここからはGreengrassの機能を使用しIoTデバイスとして実践利用できる機能実装を紹介します

### 複数ファイル

- プロジェクト単位（複数のファイル）をコンポーネントとして取り扱う方法
- ディレクトリ構造を保ったまま

#### 複数ファイル.コード
#### 複数ファイル.レシピ変更項目
#### 複数ファイル.コンポーネント変更項目
#### 複数ファイル.動作確認

### Logging

- RaspberryPiのログをクラウド（Cloudwatch）へ通知させる仕組みを構築する方法
- RESTやMQTTに頼ることなくprint文が出力されるようになります

#### Log.コード例

```python
def main()
  print("Hello Greengrass log")
```

:::details もう少しこだわるなら

```python
import logging
import sys
import time
from datetime import datetime
from zoneinfo import ZoneInfo

class JstIsoFormatter(logging.Formatter):
    """asctime を JST ISO8601 にする"""
    def formatTime(self, record, datefmt=None):
        dt = datetime.fromtimestamp(record.created, ZoneInfo("Asia/Tokyo"))
        return dt.strftime("%Y-%m-%dT%H:%M:%S.%f") + dt.strftime("%z")

def configure_logger(name: str = "com.example.HelloWorld") -> logging.Logger:
    root = logging.getLogger()
    root.handlers.clear()
    logger = logging.getLogger(name)
    logger.handlers.clear()
    logging.lastResort = None
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(logging.DEBUG)
    fmt = "%(asctime)s - (%(filename)s:%(lineno)d) - [%(levelname)s] - %(message)s"
    handler.setFormatter(JstIsoFormatter(fmt=fmt))
    logger.addHandler(handler)
    logger.setLevel(logging.DEBUG)
    logger.propagate = False
    return logger

logger = configure_logger()
logger.debug("デバッグログです。")
logger.info("通常のログです。")
logger.warning("警告です。")
logger.error("エラー発生です。")
logger.critical("緊急事態です。")
```

:::

#### Log.レシピ変更項目(Optional)

ログのリアルタイム性が重要なシステムでは以下の変更を行う~~とよいとAIから聞いた~~

```diff json
- "run": "python3 {artifacts:path}/hello_world.py '{configuration:/Message}'"
+ "run": "python3 -u {artifacts:path}/hello_world.py '{configuration:/Message}'"
```

https://docs.python.org/ja/3/using/cmdline.html#cmdoption-u

#### Log.コンポーネント変更項目

- Greengrass > デプロイにアクセスし既存のデプロイにチェックを入れた状態で右上の`変更`をクリックし以下の工程を進めます

![clickchangebutton](/images/greengrass/click_change_button.png)

デプロイの[Step2 コンポーネントの選択](#653step2-コンポーネントの選択)で選択できるパブリックコンポーネントを2つ追加します

- aws.greengrass.LogManager
- aws.greengrass.Nucleus

![clicktwopubliccomponent](/images/greengrass/click_two_public_component.png)

デプロイの[Step3 コンポーネントのを設定](#654step3-コンポーネントを設定)で追加したコンポーネントを選択した状態で右上の`コンポーネントを設定`をクリックし以下の設定を加えます

![clickcomponentsettings](/images/greengrass/click_component_settings.png)

`aws.greengrass.LogManager`

```json
{
    "logsUploaderConfiguration": {
        "systemLogsConfiguration": {
          "uploadToCloudWatch": "true",
          "minimumLogLevel": "DEBUG"
        },
        "componentLogsConfigurationMap": {
            "com.example.HelloWorld": {
                "minimumLogLevel": "DEBUG"
            }
        }
      },
    "periodicUploadIntervalSec": 5,
    "deprecatedVersionSupport": false
}
```

`aws.greengrass.Nucleus`

```json
{
    "logging": {
        "level": "DEBUG",
        "format": "JSON"
    }
}
```

![update_component_settings](/images/greengrass/update_component_settings.png)

#### Log.動作確認

- 変更をデプロイ完了した後にCloudWatchで以下のようなログが確認できます
- ロググループ`/aws/greengrass/UserComponent/ap-northeast-1/{Component name}`

![get_logs_at_cloudwatch](/images/greengrass/get_logs_at_cloudwatch.png)

```json
{
    "thread": "Copier",
    "level": "INFO",
    "eventType": "stdout",
    "message": "Hello Greengrass log",
    "contexts": {
        "scriptName": "services.com.example.HelloWorld.lifecycle.run",
        "serviceName": "com.example.HelloWorld",
        "currentState": "RUNNING"
    },
    "loggerName": "com.example.HelloWorld",
    "timestamp": ********,
    "cause": null
}
```

### MQTT Publish

- RaspnerryPiからTopicにPublishさせる仕組みを構築する方法
- 

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/ipc-iot-core-mqtt.html?utm_source=chatgpt.com

```python

from awsiot.greengrasscoreipc.clientv2 import GreengrassCoreIPCClientV2

def main():
  ipc = GreengrassCoreIPCClientV2()
  thing_name = os.getenv("AWS_IOT_THING_NAME", "thingname")
  payload = {
      "timestamp": datetime.now(ZoneInfo("Asia/Tokyo")).isoformat(timespec="milliseconds"),
      "level": "INFO",
      "message": "Hello Greengrass mqtt message",
  }
  ipc.publish_to_iot_core(
    topic_name=f"device/logs",
    payload=json.dumps(payload, ensure_ascii=False).encode("utf-8"),
    qos=1,
  )
```

#### レシピ変更項目

`ComponentConfiguration.DefaultConfiguration`を以下のように書き換えます

:::message
本設定はコンポーネント設定でも適用することが可能ですが変更管理が面倒になるのでレシピに記載することが良いと考えています
:::

```json
  "ComponentConfiguration": {
    "DefaultConfiguration": {
      "accessControl": {
        "aws.greengrass.ipc.mqttproxy": {
          "com.example.HelloWorld:mqttproxy:1": {
            "operations": [
              "aws.greengrass#PublishToIoTCore",
              "aws.greengrass#SubscribeToIoTCore"
            ],
            "policyDescription": "Allows access to publish/subscribe to all topics.",
            "resources": ["*"]
          }
        },
      }
    }
  }
```

#### コンポーネント変更項目

マイコンポーネントで以下の設定更新を行います

![reset_mycomponent_config](/images/greengrass/reset_mycomponent_config.png)

レシピの`DefaultConfiguration`をアップデートした場合はこの操作をしないとデプロイをしても通信の過程で`awsiot.greengrasscoreipc.model.UnauthorizedError`のエラーが発生し通信ができません。私はココではまりましたのでご注意ください。

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/troubleshooting.html#ipc-unauthorized-error

`aws.greengrass.Nucleus`に以下の設定を追加します

```json
{
    "interpolateComponentConfiguration": true
}
```

#### 動作確認

- IoT Core > MQTT テストクライアントにアクセスしトピックのフィルターに`devices/#`と入力しサブスクライブをクリックしておくと以下のようにSubscribeできます

```json
{
  "timestamp": "2026-01-01T01:00:00.123+09:00",
  "level": "INFO",
  "message": "Hello Greengrass mqtt message"
}
```

### MQTT Subscribe

```python
```

#### レシピ変更項目
#### コンポーネント変更項目
#### 動作確認

### Device Shado

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/ipc-local-shadows.html

```python

```

#### レシピ変更項目

`accessControl`セクションに以下を追加します

```json
        "aws.greengrass.ShadowManager": {
          "com.example.HelloWorld:shadow:1": {
            "policyDescription": "Allows access to shadows",
            "operations": [
              "aws.greengrass#GetThingShadow",
              "aws.greengrass#UpdateThingShadow",
              "aws.greengrass#DeleteThingShadow"
            ],
            "resources": [
              "$aws/things/{iot:thingName}/shadow",
              "$aws/things/{iot:thingName}/shadow/name/*"
            ]
          }
        }
```

#### コンポーネント変更項目

パブリックコンポーネントから`aws.greengrass.ShadowManager`を追加し以下の設定を加えます

```json
{
   "strategy":{
      "type":"realTime"
   },
    "synchronize":{
        "coreThing": {
            "classic":true,        //匿名shadow
            "namedShadows":["*"]   //名前付きshadow
        }
    }
}
```

#### 権限変更項目

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/sync-shadows-with-iot-core.html#shadow-sync-prereqs

- コアデバイスの画面から証明書タブ > {証明書ID} > `GreengrassV2IoTThingPolicy` > `アクティブなバージョンを編集`をクリック
![update_authority_assets](/images/greengrass/update_authority_assets.png)

以下3点の権限を追加します

- `iot:GetThingShadow`
- `iot:UpdateThingShadow`
- `iot:DeleteThingShadow`

#### 動作確認

```python
get_response = ipc.get_thing_shadow(
    thing_name=thing_name,
    shadow_name=""
)

logger.info(f"[Shadow] 取得成功: {get_response}")
```

- `モノ`のDevice ShadowタブからDeviceShadow `Classic shadow`等 をクリック
- 最終更新日やShadowの状態自体がアップデートされていることを確認できるはずです

#### はまった点

- Shadowを一度も更新していない時点では`awsiot.greengrasscoreipc.model.ResourceNotFoundError`が発生します
  - `update`する前に`get`しようとしていて`return`してしまっていたのが原因でした
- 対処法は最初に`update`するだけです


### コンポーネント/デプロイ単位の環境変数

#### レシピ変更項目

コンポーネント単位で環境変数を持つ場合はレシピの`DefaultConfiguration`を使用するのが良いと思います

```json
  "ComponentConfiguration": {
    "DefaultConfiguration": {
      "accessControl": {
        {}
      },
      "env": {
        "MY_ENV_VAR": "my env var value"
      },
      "hoge": "foo",
      "fuga": "bar"
    }
  }
```

- ネスト構造でもフラットに渡すことも可能です
- 以下、公式記載されているように数値を渡したい場合は文字列で渡した後にキャストすることが推奨されます。

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/component-recipe-reference.html#recipe-format

> AWS IoT Greengrass は設定値に JSON を使用します。JSON は数値タイプを指定しますが、整数と浮動小数点数を区別しません。その結果、AWS IoT Greengrass で設定値が浮動小数点数に変換されることがあります。コンポーネントが正しいデータタイプを使用することを確認するには、数値の設定値を文字列として定義することをお勧めします。次に、整数または浮動小数点としてコンポーネントでパースします。これにより、設定値が設定とコアデバイスに対して同じタイプであることを保証します。

:::message
`DefaultConfiguration`を変更したときは 設定更新のリセットを忘れずに行いましょう
:::

#### コンポーネント変更項目

デプロイ単位で環境変数を持つ場合はデプロイをデバイスごとに実行しコンポーネントをオーバーライドするのが良いと思います
この場合は、デプロイの[Step3 コンポーネントのを設定](#654step3-コンポーネントを設定)にてマイコンポーネントの設定変更を時に以下のように入力します

```json
{
  "DefaultConfiguration": {
    "hoge": "value"
  }
}
```

### デフォルトで用意されている環境変数

レシピやコンポーネントに設定を行わなくても用意されている環境変数がいくつかあります

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/component-environment-variables.html

一例

|変数名|内容|
|---|---|
|AWS_IOT_THING_NAME|コアデバイスの`モノ`の名前|
|AWS_REGION|コアデバイスが動作するリージョン|

#### 動作確認

受け取りコードは以下のようにします

```python

```