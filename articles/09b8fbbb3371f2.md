---
title: " 【動いてる？】現地訪問必須だったRaspberryPiの管理地獄に終止符-AWS Greengrass"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["awsiotgreengrass", "aws", "awsiotcore", "iot"]
published: false
---

# 1. はじめに

こんにちは。
私は非IT系の会社（いわゆるJTC）にて部署内のDX推進を行っており、現場の手元業務を改善するためのPoCやツール導入をメインに行っております。
PoCの中でよくあるのがRaspberry Piを使ったIoTですが、管理できていない野良デバイスがはびこる状況に頭を悩ませております。
本記事はそんな課題解決に向けた学習の記録です。

# 2. 対象読者

- RaspberryPiを使ったIoT機器の運用を検討をしている方
- OTA（Over the Air）を簡単に実装したい方
- **とりあえず動く**けど、保守性の運用性の高い設計へステップアップしたい方

# 3. 記事を読むメリット

- AWS IoT Greengrassの基礎から実践的な機能実装までを、一連のハンズオン形式で体系的に学べる
- OTA、Logging、MQTT、Device Shadowなど、実務で必要となる機能の実装方法を具体的なコード例とともに理解できる
- 「とりあえず動く」状態から、保守性・運用性の高いIoTシステムへステップアップするための知見を得られる

# 4. 学習の背景

部署向けDXをIoTデバイスを活用して開始したころの開発では、１つ１つの`モノ`を手作業でプロビジョンしリモートアクセス系の機能も実装しておりませんでした。理由はこだわりではなく

- アーキテクチャへの知識不足
- 運用数も少ないのでとにかく動けばよい

というのが本音です
この状況を見直すことなく、関与するPoCが増えても同じ方法を繰り返しておりました。
（他責にするわけではないですが、私自身が職場を一時的に離れており、関与することもできませんでした）

## 4.1. 続けた結果

気が付けば、管理できていない野良デバイスが大量生産され

- 個々の現場で暫定対策を施した野良ブランチが無数に発生し、現在の実装状況が把握できない
- 実装の確認とアップデートは物理的なアクセスが必須
- 健康に動作するかもわからないデバイスが何個かある

![manydevice](/images/greengrass/many_no_management_device.png)
*デバイス管理地獄*

- これが起因し往復700km運転した1泊出張もありました

# 5. Greengrassはどんな効果をもたらすか

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/what-is-iot-greengrass.html
https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2024_AWS-IoT-Greengrass-Basic_1106_v1.pdf

全ての機能を理解できていませんが、少なからず私の現状には以下の恩恵を受けることができます

- **OTA(Over The Air)によるリモートアップデートの導入**
  - 自前実装無しに安全なアップデートを実現可能
- **デプロイフローのクラウド強制によるガバナンス強化**
  - 本質的ではないですが。現場で蔓延する個別暫定対策を抑制し管理体制を構築できる
- **エッジ・クラウド間のパイプラインを自前実装少なく開発できる**
  - Log, Telemetry, DeviceShadowといったクラウド同期を最小限の実装コストで実現可能

DevelopmentとOperationsの広い範囲で大きな恩恵を受けられると思います(私の場合は現在地が低い)

# 6. チュートリアル-最小構成の構築方法

以下の環境で実施しました。

- 開発PC：Windows11
- IoT機器：RaspberryPi 4

開発PCとIoT機器は同じ環境を用意しないとテストが面倒になります。あくまでお試し期間であることにご留意ください。

## 6.1. チュートリアル-コアデバイスの作成

参照ドキュメント

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/install-greengrass-v2-console.html

:::message
RaspberryPiがすでにインターネットに接続できる場合は、RaspberryPiから操作することをお勧めします。
コンソール画面に何も表示されない場合は、Chromiumのアップデート `sudo apt install chromium-browser`
:::

- AWS IoT > Greengrass > コアデバイスへアクセスし
- `コアデバイスをセットアップ` > `1つのCoreデバイスをセットアップ` をクリック

![createacoredevice](/images/greengrass/create_a_core_device.png =300x)

- 以下を参考に各項目を選択/入力する

| 項目                                             | 入力値                                                 | 備考                                                                                                                                                          |
| ------------------------------------------------ | ------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| コアデバイス名                                   | デバイスを識別する固有名                               | 任意の識別できる名前 例：ID, シリアルNo                                                                                                                       |
| モノのグループ                                   | デバイス群を識別するグループ名                         | 任意の同じ設定やプログラム適用を識別できる名前 例: plant-A, plant-B                                                                                           |
| ソフトウェアランタイム                           | Greengrass nucleus                                     | RaspberryPi Pico程度の小メモリな場合は[liteを選択する](https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/greengrass-nucleus-lite-component.html) |
| オペレーティングシステム                         | Linux                                                  | 端末に合わせて設定                                                                                                                                            |
| デバイスのセットアップ方法                       | `インストーラーのダウンロードでデバイスをセットアップ` | 既にRaspberryPiが起動している場合にこれを利用                                                                                                                 |
| AWS IoT モノ                                     | クリックする                                           | `全てのデバイス`にモノが作成されます                                                                                                                          |
| 接続キットをダウンロード                         | クリックする                                           | 後からダウンロードできないのでクリック必須です                                                                                                                |
| インストーラーをダウンロード                     | クリックする                                           | RaspberryPiでGreengrass nucleus ランタイムをインストールするためのファイル一式                                                                                |
| ダウンロードをデバイスに転送してセットアップする | コードをコピーしておく                                 | RaspberryPiで実行するコマンドで後から必要になります                                                                                                                                 |

- 作成を完了させます

## 6.2. チュートリアル-RaspberryPiの初期セットアップ

- RaspberryPiでランタイム動作に必要なJavaをインストールします

```sh
sudo apt install -y openjdk-11-jdk
```

- 過程でダウンロードされる２つのファイルは以下のようにします

| ファイル種 | ファイル名 | 操作 |
| --- | --- | --- |
| インストーラー | `greengrass-nucleus-latest.zip` | `~/GreengrassInstaller`配下に解凍。GUIでは、ファイル上で右クリックし`ここでファイルを展開`をクリックするだけででOK |
| 接続キット | `{core device name}-connectionKit.zip` | `/greengrass/v2`配下に解凍。GUIでは権限不足になるため以下コマンドを実行 |

※ 本例では一時的に`/greengrass-installer-temp`フォルダを作成してGUIで解凍してから移動させています

```sh
sudo mkdir -p /greengrass/v2/
sudo cp -r ~/greengrass-installer-temp/* /greengrass/v2/
```

- `GreengrassInstaller`ディレクトリの親階層ディレクトリ（本例では`~`）でAWSからコピーした下記コマンドを実行します

```sh
sed -i 's|{{config_dir}}|/greengrass/v2|g; s|{{nucleus_component}}|aws.greengrass.Nucleus|g' /greengrass/v2/config.yaml && sudo -E java -Droot="/greengrass/v2" -Dlog.store=FILE -jar ./GreengrassInstaller/lib/Greengrass.jar --init-config /greengrass/v2/config.yaml --component-default-user ggc_user:ggc_group --setup-system-service true
```

- インストールに成功すると最終的に以下のような出力を確認できます

```text
Successfully set up Nucleus as a system service
```

- 正しく設定ができていれば、AWS IoT Greengrassのコアデバイス画面にて確認ができるはずです

![canviewcoredevice](/images/greengrass/can_view_core_device.png)

::: details 一時ファイル/greengrass/v2/{id}を開くことができませんでした

以下のメッセージが出現する場合は sudo を先頭につける

```text
sed: 一時ファイル /greengrass/v2/{id} を開くことができませんでした 許可がありません
```

:::

### 6.2.1. 通信に制限がある環境下での利用の場合

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/configure-greengrass-core-v2.html

ガバナンス強めネットワークへの参加が必須で、以下のような制限がある

- Proxyサーバーを経由する
- MQTTプロトコルが制限されている

このような場合は、以下の追加実行が必要です

- `./GreengrassInstaller/config.yaml`を作成し以下のように設定

```yaml: config.yaml
---
system:
  certificateFilePath: "/greengrass/v2/device.pem.crt"
  privateKeyPath: "/greengrass/v2/private.pem.key"
  rootCaPath: "/greengrass/v2/AmazonRootCA1.pem"
  thingName: "{your thing name}"
services:
  aws.greengrass.Nucleus:
    componentType: "NUCLEUS"
    configuration:
      mqtt:
        port: 443
      greengrassDataPlanePort: 443
      networkProxy:
        proxy:
          url: "{your proxy server URL}"
      awsRegion: "{your region}"
      iotRoleAlias: "GreengrassV2TokenExchangeCoreDeviceRoleAlias"
      iotDataEndpoint: "{your endpoint}" # マネジメントコンソールにも記載されています AWS IoT > 接続 > ドメイン設定 > iot:Data-ATS のドメイン名
      iotCredEndpoint: "{your endpoint}" # {core device name}-connectionKit.zip 内の config.yamlに記載されています
```

以下のコマンドでインストール実行
```sh
sudo -E java -Droot="/greengrass/v2" -Dlog.store=FILE -jar ./GreengrassInstaller/lib/Greengrass.jar --aws-region "{your region}" --thing-name "{your thing name}" --component-default-user ggc_user:ggc_group --provision false --setup-system-service true --init-config ./GreengrassInstaller/config.yaml
```

:::message
環境に応じて`config.yaml`を調整してください
私の環境では上記設定でport 443を使用したMQTTの動作確認まで出来ました
:::

## 6.3. チュートリアル-S3バケットとサンプルファイルを作成

参照ドキュメント

https://docs.aws.amazon.com/greengrass/v2/developerguide/create-first-component.html

バケットを新たに用意し、以下のような構造を作成する

```text
bucket
    └ artifacts
        └ {component name}
            └ {version}
                └ {your program}
```

以下のソースファイルを作成し`{bucket name}/artifacts/com.example.HelloWorld/1.0.0/`に配置

```python:hello_world.py
import sys
message = "Hello, %s!" % sys.argv[1]

print(message)
```

## 6.4. チュートリアル-コンポーネントを作成する

コンポーネントとは`Recipes`と`Artifacts`から構成される、動作プログラムやデバイス設定等を持つ再利用可能なソフトウエアモジュールのことです

作り方はCLIを初め様々な方法があるようですが、GUIで簡単に作る方法で進めます

- `AWS IoT` > `Greengrass` > `コンポーネント` へアクセスしコンポーネントを作成をクリック
- `レシピをJSONとして入力します`を選択
- 作成されるサンプルの`L.23`を作成したバケット構造に合わせて修正

```diff json
 "Manifests": [
    {
      "Platform": {
        "os": "linux"
      },
      "Name": "Linux",
      "Lifecycle": {
        "run": "python3 {artifacts:path}/hello_world.py '{configuration:/Message}'"
      },
      "Artifacts": [
        {
-          "Uri": "s3://EXAMPLE_BUCKET/artifacts/com.example.HelloWorld/1.0.0/hello_world.py",
+          "URI": "s3://{your bucket name}/artifacts/com.example.HelloWorld/1.0.0/hello_world.py"
```

- コンポーネントの作成をクリックし完成させる

## 6.5. チュートリアル-権限付与

参照ドキュメント

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/device-service-role.html

- コアデバイスがS3にアクセスしコンポーネントを取得できるための権限を付与します
- こちらも様々な手段があるようですが、本例では簡素に作成します。運用向けの手段ではないことにご留意ください

<br>

- `IAM` > `ロール`にアクセス
- `GreengrassV2CoreDeviceRole`を検索
- 以下の権限を追加付与する
  - `s3:GetBucketLocation`
  - `s3:GetObject`

:::message

- 公式ドキュメントでは`GreengrassV2TokenExchangeRole`を使用するよう記述がありますが、少なくとも私の環境では同名の物が存在せず`GreengrassV2CoreDeviceRole`という名前に置き換わっていると推測しました
- ご自身の環境を確認しながら進めてください

:::

## 6.6. チュートリアル-デプロイ

- `AWS IoT` > `Greengrass` > `デプロイ`へアクセスし`作成`をクリック

### 6.6.1. デプロイ-Step1.ターゲットを指定

- デプロイの`名前`を入力する

:::message

１度作成したデプロイオブジェクトは再デプロイ時に、変更/更新する運用になります
よって、**日時情報**は命名に使用せず、対象のデプロイターゲットが**どんなものか**を命名に使用するのが良いと思っています

:::

- デプロイするコアデバイスもしくはモノのグループを指定する

### 6.6.2. デプロイ-Step2.コンポーネントの選択

- マイコンポーネントから[チュートリアル-コンポーネントを作成する](#64-チュートリアル-コンポーネントを作成する)で作成したコンポーネントを選択します 例: `com.example.HelloWorld`

- パブリックコンポーネントはチュートリアルでは使用しません

### 6.6.3. デプロイ-Step3.コンポーネントを設定

- 各コンポーネントに追加設定を行うことができますがチュートリアルでは使用しません

<br>

#### 6.6.3.1. 設定変更を行う方法

後述しますが、実践的な機能実装では本ステップでの設定変更が必須となります。
具体的な設定変更方法の詳細手順は以下のように行います

- 設定変更するコンポーネントを選択
- 右上の`コンポーネントを設定`をクリック

![clickcomponentsettings](/images/greengrass/click_component_settings.png =300x)

- 適用する変更は右側の`設定の更新`セクションにjson形式で入力します

![update_component_settings](/images/greengrass/update_component_settings.png =400x)
*入力例*

### 6.6.4. デプロイ-Step4.詳細設定を構成

- 初期設定のままでOKです

### 6.6.5. デプロイ-Step5.レビュー

- 設定を一通り確認し`デプロイ`をクリック

## 6.7. チュートリアル-動作確認

- デプロイに成功した場合、RaspberryPiにて作成した`com.example.HelloWorld`が動作しているはずです
- Raspberry Piにて動作の履歴確認を行うには以下のコマンドを実行します

```sh
sudo tail -f /greengrass/v2/logs/{component name}.log
# 入力例 sudo tail -f /greengrass/v2/logs/com.example.HelloWorld.log
# 出力例 Hello, world!
```

# 7. 実践編

ここまでのチュートリアルで、Greengrassを使ったデプロイメントのリモート実行（OTA）ができることを確認しました。
以降では、実際の運用で必要となる以下の機能実装について解説します。

- 複数ファイルで構成されるプロジェクトのデプロイ
- 環境変数の設定と取得
- 外部ライブラリのインストール
- CloudWatch Logsへのログ出力
- MQTTによるPub/Sub通信
- Device Shadowによるデバイス状態管理
- boto3を使ったAWSサービスの直接操作

# 8. 複数ファイル

- プロジェクト単位（複数のファイル）をコンポーネントとして取り扱う方法

## 8.1. 複数ファイル-コード

- コード自体に特別な実装はなし
- サブフォルダを含めてzipファイルに圧縮しS3に保存する
  - 当然ですがzipを解凍した時の構造と後述のレシピに記載する`Uri`のエントリーポイントのパスが一致するように圧縮が必要です

## 8.2. 複数ファイル-レシピ変更項目

参考ドキュメント

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/component-recipe-reference.html#recipe-variables

- `コンポーネント`にて新バージョンを作成
- レシピ内容に以下のような環境変数を追加設定します

```diff json
"Manifests": [
    {
      "Lifecycle": {
-        "run": "python3 -u {artifacts:path}/hello_world.py"
+        "run": "python3 -u {artifacts:decompressedPath}/artifact/hello_world.py"
      },
      "Artifacts": [
        {
-          "Uri": "s3://{Bucket name}/artifacts/{component name}/{version}/hello_world.py",
+          "Uri": "s3://{Bucket name}/artifacts/{component name}/{version}/artifact.ZIP",
-          "Unarchive": "NONE",
+          "Unarchive": "ZIP",
```

## 8.3. 複数ファイル.コンポーネント変更項目

変更なし

## 8.4. 複数ファイル.動作確認

従来通り、ログを確認する

<br>
---

# 9. 環境変数

- コンポーネント（同じソースコードを使用する）単位で環境変数を設定する方法
- デプロイ（コアデバイスやコアデバイスグループ）単位で環境変数を設定する方法

## 9.1. 環境変数-レシピ変更項目

**コンポーネント単位**で環境変数を持つ場合はレシピの`DefaultConfiguration`を使用するのが良いと思います

- `コンポーネント`にて新バージョンを作成
- レシピ内容に以下のような環境変数を追加設定します

```diff json
  "ComponentConfiguration": {
    "DefaultConfiguration": {
+      "env": {
+        "MY_ENV_VAR": "my env var value"
+      },
+      "hoge": "foo",
+      "fuga": "bar"
    }
  }
```

- ネスト構造もサポートされておりjsonで渡すことが可能です
- 公式ドキュメントによると数値は文字列で渡した後にキャストすることが推奨されます。

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/component-recipe-reference.html#recipe-format

### 9.1.1. 環境変数-レシピ変更時の注意点

- `DefaultConfiguration`をアップデートした後、以降の作業を実施しないと`awsiot.greengrasscoreipc.model.UnauthorizedError`が発生することがありますのでご注意ください
  - [UnauthorizedError](https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/troubleshooting.html#ipc-unauthorized-error)

<br>

- [Step3 コンポーネントを設定](#663-デプロイ-step3コンポーネントを設定)にてマイコンポーネントの設定変更にアクセス
- `設定の更新`セクションの`設定をマージする前にリセット`で`選択した設定をリセット(高度)`にて空文字を指定

  ![reset_mycomponent_config](/images/greengrass/reset_mycomponent_config.png)

## 9.2. 環境変数-コンポーネント変更項目

**デプロイ単位**で環境変数を持つ場合はデプロイ過程にてコンポーネントをオーバーライドするのが良いと思います

- `デプロイ`にて既存のデプロイにチェックを入れた状態で右上の`変更`をクリック
- [Step3 コンポーネントを設定](#663-デプロイ-step3コンポーネントを設定)にてマイコンポーネント以下のように設定変更します

```diff json
{
+  "DefaultConfiguration": {
+    "hoge": "value"
+  }
}
```

## 9.3. 環境変数-ライフサイクル変数

ライフサイクル変数として環境変数を設定することも可能です

```diff json
  "Manifests": [
    {
      "Lifecycle": {
+          "Setenv": {
+              "VAR_TEST": "test_string"
+          },
```

## 9.4. 環境変数-デフォルトで用意されている変数

デフォルトで用意されている環境変数がいくつかあります

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/component-environment-variables.html

一例

|変数名|内容|
|---|---|
|AWS_IOT_THING_NAME|コアデバイスの`モノ`の名前|
|AWS_REGION|コアデバイスが動作するリージョン|

## 9.5. 環境変数.コード

```python
import os

from awsiot.greengrasscoreipc.clientv2 import GreengrassCoreIPCClientV2

ipc = GreengrassCoreIPCClientV2()

thing_name = os.getenv("AWS_IOT_THING_NAME", "thingname") # デフォルト用意の環境変数
thing_name = os.getenv("VAR_TEST", "test")                # ライフサイクルの環境変数
config = ipc.get_configuration()                          # レシピ or コンポーネント設定の環境変数
config.value.get("DefaultConfiguration", "nothing")       # レシピ or コンポーネント設定の環境変数
```

<br>
---

# 10. ライブラリインストール

- `pip`を使ったインストールやSDKの導入を行う方法
- IoTデバイス本体へのインストールをライフクルの中で自動化、もしくはコンポーネントに含めて渡すようにします

## 10.1. ライブラリ-レシピ変更項目

本体の実行環境に自動的にインストールする場合はレシピを使用します

- 事前にインストールするアセットを記入した`requirements.txt`を用意します
- デプロイする`.ZIP`のrootに配置されるよう圧縮します

```text:requirements.txt
awsiotsdk
```

- `コンポーネント`にて新バージョンを作成
- レシピ内容に以下のh追加設定をします

```diff json
  "Manifests": [
    {
      "Lifecycle": {
+        "install": {
+          "Script": "pip install -r {artifacts:decompressedPath}/artifact/requirements.txt"
+        },
```

- 従来通りデプロイを行うと`run`前に`Script`の内容が実行されインストールされます

## 10.2. ライブラリ-コード

SDK等をコンポーネントに同封してプロジェクト内に含めてしまう場合はコードのみ修正します
この手段は、デプロイ過程でインストールするよりもデプロイ時間が短縮されるメリットがあります
一方で、ZIP化されたファイルサイズが大きくなることやインポートのコードが若干複雑になるデメリットがあります

- プロジェクト内にSDKをインストールします

```diff text
/
+ ├ lib
  └ hello_world.py
```

```shell
pip install awsiotsdk -t ./lib
```

- コードを以下のように実装します
- レシピやコンポーネント設定でZIP利用以外に追加変更する必要はありません

```python:hello_world.py
from pathlib import Path
sys.path.insert(0, str(Path(__file__).parent / "lib"))

from awsiot.greengrasscoreipc.clientv2 import GreengrassCoreIPCClientV2
```

<br>
---

# 11. Logging

- 動作ログをCloud Watchへ通知させる方法
- RESTやMQTTを一切実装することなくprint文が出力されるようになります

## 11.1. Log-レシピ変更項目(Optional)

ログのリアルタイム性が重要なシステムでは以下の変更を行います~~と良いとGeminiが言っていた~~

- `コンポーネント`にて新バージョンを作成
- レシピ内容に以下の追加設定をします

```diff json
- "run": "python3 {artifacts:path}/hello_world.py'"
+ "run": "python3 -u {artifacts:path}/hello_world.py"
```

https://docs.python.org/ja/3/using/cmdline.html#cmdoption-u

## 11.2. Log-コンポーネント変更項目

- `デプロイ`にて既存のデプロイにチェックを入れた状態で右上の`変更`をクリック
- [Step2 コンポーネントの選択](#662-デプロイ-step2コンポーネントの選択)で以下のパブリックコンポーネントを追加します

- `aws.greengrass.LogManager`
- `aws.greengrass.Nucleus`

![click_two_public_component](/images/greengrass/click_two_public_component.png =500x)

- [Step3 コンポーネントの設定](#663-デプロイ-step3コンポーネントを設定)にて追加したコンポーネントに以下の設定変更をします

`aws.greengrass.LogManager`

```json
{
    "logsUploaderConfiguration": {
        "systemLogsConfiguration": {
          "uploadToCloudWatch": "true",
          "minimumLogLevel": "DEBUG"
        },
        "componentLogsConfigurationMap": {
            "com.example.HelloWorld": {
                "minimumLogLevel": "DEBUG"
            }
        }
      },
    "periodicUploadIntervalSec": 5,
    "deprecatedVersionSupport": false
}
```

`aws.greengrass.Nucleus`

```json
{
    "logging": {
        "level": "DEBUG",
        "format": "JSON"
    }
}
```

![update_component_settings](/images/greengrass/update_component_settings.png)

## 11.3. Log-コード例

```python
def main()
  print("Hello Greengrass log")
```

:::details もう少し力を入れるなら

```python
import logging
import sys
import time
from datetime import datetime
from zoneinfo import ZoneInfo

class JstIsoFormatter(logging.Formatter):
    """asctime を JST ISO8601 にする"""
    def formatTime(self, record, datefmt=None):
        dt = datetime.fromtimestamp(record.created, ZoneInfo("Asia/Tokyo"))
        return dt.strftime("%Y-%m-%dT%H:%M:%S.%f") + dt.strftime("%z")

def configure_logger(name: str = "com.example.HelloWorld") -> logging.Logger:
    root = logging.getLogger()
    root.handlers.clear()
    logger = logging.getLogger(name)
    logger.handlers.clear()
    logging.lastResort = None
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(logging.DEBUG)
    fmt = "%(asctime)s - (%(filename)s:%(lineno)d) - [%(levelname)s] - %(message)s"
    handler.setFormatter(JstIsoFormatter(fmt=fmt))
    logger.addHandler(handler)
    logger.setLevel(logging.DEBUG)
    logger.propagate = False
    return logger

logger = configure_logger()
logger.debug("デバッグログです。")
logger.info("通常のログです。")
logger.warning("警告です。")
logger.error("エラー発生です。")
logger.critical("緊急事態です。")
```

:::

## 11.4. Log.動作確認

- CloudWatchで以下のようなログが確認できます
- ロググループ`/aws/greengrass/UserComponent/ap-northeast-1/{Component name}`

![get_logs_at_cloudwatch](/images/greengrass/get_logs_at_cloudwatch.png)

```json
{
    "thread": "Copier",
    "level": "INFO",
    "eventType": "stdout",
    "message": "Hello Greengrass log",
    "contexts": {
        "scriptName": "services.com.example.HelloWorld.lifecycle.run",
        "serviceName": "com.example.HelloWorld",
        "currentState": "RUNNING"
    },
    "loggerName": "com.example.HelloWorld",
    "timestamp": ********,
    "cause": null
}
```

<br>
---

# 12. MQTT

- MQTT Publish/Subscribe機能を実装する方法

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/ipc-iot-core-mqtt.html?utm_source=chatgpt.com

## 12.1. MQTT-レシピ変更項目

- `コンポーネント`にて新バージョンを作成
- レシピ内容に以下の追加設定をします

:::message
本設定はデプロイの`Step3-コンポーネント設定`でも適用することが可能ですが、変更管理が難しくなるのでレシピに記載する方が良いと考えます
:::

```diff json
  "ComponentConfiguration": {
    "DefaultConfiguration": {
+      "accessControl": {
+        "aws.greengrass.ipc.mqttproxy": {
+          "com.example.HelloWorld:mqttproxy:1": {
+            "operations": [
+              "aws.greengrass#PublishToIoTCore",
+              "aws.greengrass#SubscribeToIoTCore"
+            ],
+            "policyDescription": "Allows access to publish/subscribe to all topics.",
+            "resources": ["*"]
+          }
+        },
+      }
    }
  }
```

- topicを限定して`resources`で指定する場合は、以下のような方法でTopicを指定することができます

```diff json
-"resources": ["*"]
+"resources": [
+  "devices/{iot:thingName}/heartbeat",
+  "devices/{iot:thingName}/logs",
+  "devices/{iot:thingName}/cmd"
+]
```

## 12.2. MQTT-コンポーネント変更項目

レシピにて`{iot:thingName}`(レシピ変数)を用いた場合は`aws.greengrass.Nucleus`に以下の設定を追加設定します
`"*"`を使用する場合は追加設定不要です

```diff json
{
+  "interpolateComponentConfiguration": true
}
```

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/component-recipe-reference.html#recipe-variables

## 12.3. MQTT-Publishコード

- `awsiotsdk`の[インストール](#10-ライブラリインストール)を実施しておきます
- [環境変数](#9-環境変数)を用いてTopicに使用するとより実践的です

```python
import os
import json

from datetime import datetime
from zoneinfo import ZoneInfo

from awsiot.greengrasscoreipc.clientv2 import GreengrassCoreIPCClientV2

ipc = GreengrassCoreIPCClientV2()
thing_name = os.getenv("AWS_IOT_THING_NAME", "thing_name") #環境変数取得
payload = {
    "timestamp": datetime.now(ZoneInfo("Asia/Tokyo")).isoformat(timespec="milliseconds"),
    "level": "INFO",
    "message": "Hello Greengrass mqtt message",
}
ipc.publish_to_iot_core(
  topic_name=f"device/{thing_name}/logs",
  payload=json.dumps(payload, ensure_ascii=False).encode("utf-8"),
  qos=1,
)
```

## 12.4. MQTT-Subscribeコード

- `awsiotsdk`の[インストール](#10-ライブラリインストール)を実施しておきます
- [環境変数](#9-環境変数)を用いてTopicに使用するとより実践的です

```python
import os
import threading

import awsiot.greengrasscoreipc.clientv2 as clientV2

def on_stream_event(event):
    try:
        topic_name = event.message.topic_name
        message = str(event.message.payload, 'utf-8')
        print(f'Received new message on topic {topic_name}: {message}')
    except Exception as e:
        traceback.print_exc()

ipc = GreengrassCoreIPCClientV2()
thing_name = os.getenv("AWS_IOT_THING_NAME", "thing_name")
topic_name = f"devices/{thing_name}/cmd"

resp, operation = ipc.subscribe_to_iot_core(
    topic_name=topic_name,
    qos=1,
    on_stream_event=on_stream_event,
    on_stream_error=lambda e: False,
    on_stream_closed=lambda: print("Stream closed")
)

threading.Event().wait()  # Keep the main thread alive to receive messages
```

## 12.5. MQTT-動作確認

- IoT Core > MQTT テストクライアントにアクセス

### 12.5.1. Publish

- トピックのフィルターに`devices/#`と入力しサブスクライブをクリックしておく

```json
{
  "timestamp": "2026-01-01T01:00:00.123+09:00",
  "level": "INFO",
  "message": "Hello Greengrass mqtt message"
}
```

### 12.5.2. Subscribe

- `トピックに公開する`タブをクリック
- トピック名を`devices/{your things name}/cmd`
- メッセージペイロードに`{ "message": "Hello Greengrass mqtt Subscribe message" }`を入力
- 追加設定をクリックし`サービス品質`を**1**に設定する
- 発行をクリック

```json
{
    "thread": "Copier",
    "level": "INFO",
    "eventType": "stdout",
    "message": "Received new message on topic devices/your things name}/cmd:  { \"message\": \"Hello Greengrass mqtt Subscribe message\" }",
    "contexts": {
        "scriptName": "services.com.example.HelloWorld.lifecycle.run",
        "serviceName": "com.example.HelloWorld",
        "currentState": "RUNNING"
    },
    "loggerName": "com.example.HelloWorld",
    "timestamp": ********,
    "cause": null
}
```

<br>
---

# 13. DeviceShadow

- クラウドのDeviceShadowでデバイス管理する方法

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/ipc-local-shadows.html

## 13.1. Shadow-レシピ変更項目

- `コンポーネント`にて新バージョンを作成
- レシピの`accessControl`配下に以下の追加設定をします

```diff json
  "ComponentConfiguration": {
    "DefaultConfiguration": {
      "accessControl": {
+        "aws.greengrass.ShadowManager": {
+          "com.example.HelloWorld:shadow:1": {
+            "policyDescription": "Allows access to shadows",
+            "operations": [
+              "aws.greengrass#GetThingShadow",
+              "aws.greengrass#UpdateThingShadow",
+              "aws.greengrass#DeleteThingShadow"
+            ],
+            "resources": [
+              "$aws/things/{iot:thingName}/shadow",       //匿名Shadow
+              "$aws/things/{iot:thingName}/shadow/name/*" //名前付きShadow
+            ]
+          }
+        }
```

## 13.2. Shadow-コンポーネント変更項目

- `デプロイ`にて既存のデプロイにチェックを入れた状態で右上の`変更`をクリック
- [Step2 コンポーネントの選択](#662-デプロイ-step2コンポーネントの選択)で以下のパブリックコンポーネントを追加します
  - `aws.greengrass.ShadowManager`

- [Step3 コンポーネントの設定](#663-デプロイ-step3コンポーネントを設定)で追加したコンポーネントに以下の設定変更をします

```json
{
   "strategy":{
      "type":"realTime"
   },
    "synchronize":{
        "coreThing": {
            "classic":true,        //匿名shadow
            "namedShadows":["*"]   //名前付きshadow
        }
    }
}
```

## 13.3. Shadow-権限変更項目

- `モノ`に権限を追加する必要があります

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/sync-shadows-with-iot-core.html#shadow-sync-prereqs

- `コアデバイス`の画面から`証明書`タブ > `{証明書ID}` > `GreengrassV2IoTThingPolicy` > `アクティブなバージョンを編集`をクリック
![update_authority_assets](/images/greengrass/update_authority_assets.png =500x)

:::message
本例では`GreengrassV2IoTThingPolicy`に追加しておりますがご自身でポリシーを追加する等、適時ご判断ください
:::

以下3点の権限を追加します

- `iot:GetThingShadow`
- `iot:UpdateThingShadow`
- `iot:DeleteThingShadow`

## 13.4. Shadow-コード

```python
import os
import json

from datetime import datetime, timezone

import awsiot.greengrasscoreipc.clientv2 as clientV2

ipc = clientV2.GreengrassCoreIPCClientV2()
thing_name = os.getenv("AWS_IOT_THING_NAME", "thing_name") #環境変数を取得

new_state = {
    "state": {
        "reported": {
            "welcome": "aws-iot",
            "status": "running",
            "timestamp": datetime.now(timezone.utc).isoformat(timespec="milliseconds")
        }
    }
}

# Shadowの更新
update_response = ipc.update_thing_shadow(
    thing_name=thing_name,
    shadow_name="",  # 匿名Shadowは空文字 名前付きはShadow名
    payload=json.dumps(new_state).encode("utf-8")
)

# Shadowの取得
get_response = ipc.get_thing_shadow(
    thing_name=thing_name,
    shadow_name=""  # 匿名Shadowは空文字 名前付きはShadow名
)
```

## 13.5. Shadow-動作確認

- `モノ`のDevice ShadowタブからDeviceShadow `Classic shadow`等 をクリック

![click_thing_classic_shadow](/images/greengrass/click_thing_classic_shadow.png =400x)

- 最終更新日やShadowの状態自体がアップデートされていることを確認できます

## 13.6. Shadow-はまった点

- Shadowを一度も更新していない段階で`Get`をすると`awsiot.greengrasscoreipc.model.ResourceNotFoundError`が発生します
  - 原因は `get` -> 失敗したらreturn -> `update`の順で処理していたことでした
- 対処法は最初に`update`することです

<br>
---

# 14. AWSの直接操作

参照ドキュメント
https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/interact-with-aws-services.html

- boto3を使用した直接的な操作をアクセスキーやシークレット等無しに実施することができます

## 14.1. AWS直接操作-レシピ変更項目

- `コンポーネント`にて新バージョンを作成
- レシピ内容に以下の追加設定をします

```diff json
  "ComponentConfiguration": {
    "DefaultConfiguration": {
      "accessControl": {
      }
    }
  },
+  "ComponentDependencies": {
+    "aws.greengrass.TokenExchangeService": {
+      "VersionRequirement": "^2.0.0",
+      "DependencyType": "HARD"
+    }
+  },
```

## 14.2. AWS直接操作-コンポーネント変更項目

無し

## 14.3. AWS直接操作-権限変更項目

- コアデバイスが使用するロールに権限を追加する必要があります
- 例えば`GreengrassV2CoreDeviceRole`。 適時ご判断ください
- 例えばS3にIoTデバイスからファイルを直接アップロードさせる場合には以下のように権限を付与します

```json
{
  "Sid": "VisualEditor",
  "Effect": "Allow",
  "Action": "s3:PutObject",
  "Resource": [
    "arn:aws:s3:{region}:{account id}:accesspoint/*/object/*",
    "arn:aws:s3:::{bucket name}/*"
  ]
}
```

## 14.4. AWS直接操作-コード

https://boto3.amazonaws.com/v1/documentation/api/latest/index.html

```diff text:requirements.txt
awsiotsdk
+boto3
```

- S3にファイルを送信する

```python
import boto3
s3 = boto3.client("s3")

s3_client.upload_file(file_path, bucket_name)
```

<br>
---

# 15. まとめ

本記事では、手作業によるIoTデバイス管理の課題から脱却するため、AWS IoT Greengrassを活用した解決策をハンズオン形式で紹介しました。
Greengrassを導入することで、以下のような恩恵を受けることができることを確認することができました

- **OTAによるリモートアップデート**: 現地に赴くことなく、遠隔で安全にアプリケーションを更新できます。
- **デプロイフローの統一**: クラウド経由でのデプロイを強制することで、いわゆる「野良ブランチ」の発生を抑制し、ガバナンスを強化します。
- **実装コストの削減**: Logging, MQTT, Device Shadowといったクラウド連携機能を、最小限の実装で実現できます。

![management_device_only](/images/greengrass/management_device_only.png =400x)

# 16. 終わりに

本記事内容のみではせいぜい数個～十数個程度のデバイス管理までが限界だと思います
より多くのデバイスを扱う場合は本記事では触れていない以下の検討が必要になるはずです

- AWS System Managerとの連携
- CI/CDの導入

ここら辺もいつかまとめたいと考えています

- かつては「とりあえず動く」ことを優先し、結果として管理不能なデバイスを増やしてしまった苦い経験がありました
- Greengrassは、そうした場当たり的な運用から脱却し、スケーラブルで保守性の高いIoT管理体制を構築できるための強力なツールだと感じています
- 私と同じように、管理されていないIoTデバイスの増加に悩みを抱えている方の、はじめの一歩となれば幸いです

大変長くなってしまいましたが、自身が見返して利用することを考えると記事分散している方が検索性が下がると考え１記事にしました
最後までご覧いただいた方いらっしゃいましたらありがとうございました。
