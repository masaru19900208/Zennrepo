---
title: "AWS GreenGrass による、簡単でちょっといい感じのIoT機器管理"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["awsiotgreengrass", "aws", "awsiotcore", "iot"]
published: false
---

## 1.はじめに

こんにちは。
私は普段、非IT系の事業会社（いわゆるJTC）にて「部署内DX」の推進役を担っており、現場の手元業務を即座に改善するためのPoCやツール活用をメインに行っております。
PoCの中でよくあるのがRaspberryPiを使ったIoTですが、やっといい感じの運用方法が分かってきたので共有したいと思います

## 2.対象読者

- RaspberryPiを使ったIoT機器の運用を検討している方
- 「とりあえず動く」けど、保守性の運用性の高い設計へステップアップしたい方

## 3.記事を読むメリット

- AWS IoT Greengrassについてざっくり知れる

## 4. 学習の背景
<!-- Greengrassで、プロビジョンを簡素化、OTA機能を簡単に構築 このメリットを最大化できるような前提を記載する -->
これまでIoT機器開発においては、ほとんどの場合で、IoT Coreで"モノ"を作成し１つ１つ手作業でプロビジョンする手段を採用してきました。理由はこだわりではなく、

- アーキテクチャへの知識不足
- 運用数が少ないという

というのが本音です。
また、そもそも運用を見据えた機能が不足していたこともあり、以下の課題に直面することが多々ありました。

- IoT機器に組み込まれたプログラムが把握できない（現場で担当者が暫定対策を施した野良ブランチ）
- プログラムをアップデートするリソースが膨大

## 5.AWS IoT Greengrassとは

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/what-is-iot-greengrass.html

公式では以下のように記されています

> AWS IoT Greengrass は、デバイスで IoT アプリケーションを構築、デプロイ、管理するうえで役立つオープンソースのモノのインターネット (IoT) エッジランタイムとクラウドサービスです。

私が最も恩恵を受けている部分は、課題であったデプロイメントの大変さを解消してくれる点で、OTA（Over the air）を特別な実装無しに構築することができる点です。
その他も色々ありますが完全に把握しきれていません。

## 6.始めかた

管理PC：Windows11
IoT機器：RaspberryPi 4

### 6.1.AWS Greengrassでの初期セットアップ

---

参照ドキュメント

https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/install-greengrass-v2-console.html

:::message
RaspberryPiがすでに初期セットアップ済みの場合は、RaspberryPiからAWSにアクセスし操作することをお勧めします。
:::

- AWS IoT > Greengrass > コアデバイスへアクセスし、右上の”コアデバイスをセットアップ” > "1つのCoreデバイスをセットアップ" をクリック

![createacoredevice](/images/greengrass/create_a_core_device.png)

- 以下を参考に各項目を選択/入力する

| 項目                                             | 入力値                                               | 備考                                                                                                                                                                                                           |
| ------------------------------------------------ | ---------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| コアデバイス名                                   | デバイス固有の名前                                   | 後から識別できる名前を付ける e.g. S/N                                                                                                                                                                          |
| モノのグループ                                   | 初回は新しいグループを作成する                       | 設定やプログラムを適用する単位の識別できる名前を付ける e.g. dev-raspi-g                                                                                                                                        |
| ソフトウェアランタイム                           | Greengrass nucleus                                   | [RaspberryPi Pico](https://akizukidenshi.com/catalog/g/g116132/) くらい小メモリなモノは[liteがよい](https://docs.aws.amazon.com/ja_jp/greengrass/v2/developerguide/greengrass-nucleus-lite-component.html) |
| オペレーティングシステム                         | Linux                                                | 端末に合わせて設定                                                                                                                                                                                             |
| デバイスのセットアップ方法                       | インストーラーのダウンロードでデバイスをセットアップ | 既にRaspberryPiでOSが起動していてセットアップを完了している場合はこちらを選択すると良い                                                                                                                        |
| AWS IoT モノ                                     | クリックする                                     | モノが作成される                                                                                                                                                                                               |
| 接続キットをダウンロード                         | クリックする                                     | 後からダウンロードできないので必須                                                                                                                                                                             |
| インストーラーをダウンロード                     | クリックする                                     | RaspberryPiでGreengrass nucleus ランタイムをインストールするためのファイル一式                                                                                                                                 |
| ダウンロードをデバイスに転送してセットアップする | コードをコピーしておく                               | RaspberryPiで実行するコマンド |

- 作成を完了させる

### 6.2.Edgeデバイス(RaspberryPi)での初期セットアップ

---

- RaspberryPiでランタイム動作に必要なJavaをインストールする

```sh
sudo apt install -y openjdk-11-jdk
```

- AWSからダウンロードした２つのファイル`接続キット`、`インストーラー`をRaspberryPi内に配置し解凍する
- `接続キット`を `~/GreengrassInstaller`フォルダに配置する
- `インストーラー`を`/greengrass/v2`に配置する（以下の例では解凍時に一時的に`/greengrass-installer-temp`フォルダに配置していたものを移動）

```sh
sudo mkdir /greengrass/v2/
sudo cp -r ~/greengrass-installer-temp/* /greengrass/v2/
```

- `接続キット`を配置したディレクトリ（本例では`~`）に移動しAWSからコピーした下記コマンドを実行する

```sh
sed -i 's|{{config_dir}}|/greengrass/v2|g; s|{{nucleus_component}}|aws.greengrass.Nucleus|g' /greengrass/v2/config.yaml && sudo -E java -Droot="/greengrass/v2" -Dlog.store=FILE -jar ./GreengrassInstaller/lib/Greengrass.jar --init-config /greengrass/v2/config.yaml --component-default-user ggc_user:ggc_group --setup-system-service true
```

- インストールに成功すると最終的に以下のような出力を確認できます

```text
Successfully set up Nucleus as a system service
```

- 同時にAWS IoT Greengrassのコアデバイス画面でも作成したコアデバイスがステータス正常となって表示されるはずです

![canviewcoredevice](/images/greengrass/can_view_core_device.png)

#### 6.3.S3バケットとサンプルファイルを作成

バケット名は任意ですが以下のような構造を作っておくと便利だと思われます

```text
bucket
    ├ artifacts
        └ {component name}
            └ {version e.g. 1.0.0}
                └ {your program}
```

[公式ドキュメント](https://docs.aws.amazon.com/greengrass/v2/developerguide/create-first-component.html)を参考に以下のプログラムを`/1.0.0`に配置

```python:hello_world.py
import sys
message = "Hello, %s!" % sys.argv[1]

print(message)
```

### 6.4.コンポーネントを作成する

---

コンポーネントとは`Recipes`と`Artifacts`から構成される、動作プログラムやデバイス設定等を持つ再利用可能なソフトウエアモジュールのことと捉えられます

https://docs.aws.amazon.com/greengrass/v2/developerguide/create-first-component.html

作り方はCLIを初め様々な方法があるようですが、最も簡素な方法で作るなら以下のような流れかと思います。

- AWS IoT > Greengrass > コンポーネントへアクセスしコンポーネントを作成をクリック
- レシピをJSONとして入力しますを選択
- 表示されるサンプルの内L.23を修正

```json
"URI": "s3://{your bucket name}/artifacts/com.example.HelloWorld/1.0.0/hello_world.py"
```

- コンポーネントの作成をクリックし完成させる

### 6.5.デプロイする

- AWS IoT > Greengrass > デプロイへアクセスし作成をクリック

#### 6.5.1.前準備

- コアデバイスが使用するIAMロールを設定します
- 以下の参照ドキュメントでは`GreengrassV2TokenExchangeRole`を使用するよう記述がありますが私の環境では同名の物が存在しませんでした。これを参考に進める場合は、ご自身の環境を確認しながら進めてください。

https://docs.aws.amazon.com/greengrass/v2/developerguide/device-service-role.html?icmpid=docs_gg_console

- IAM > ロールにアクセス
- `GreengrassV2CoreDeviceRole`を探す
- 以下の権限を追加付与する
  - `s3:GetBucketLocation`
  - `s3:GetObject`

#### 6.5.2.Step1 ターゲットを指定

- デプロイの名前を入力する

:::message
対象のデプロイターゲットを識別するような命名が良いと思われます。
１度作成したデプロイオブジェクトは再デプロイする際に、変更/更新して使いまわす運用になるため。
:::

- デプロイするコアデバイスもしくはモノのグループを指定する


#### 6.5.3.Step2 コンポーネントを設定

- マイコンポーネントから[6.4.コンポーネントを作成する](#64コンポーネントを作成する)で作成したコンポーネントを選択する e.g. `com.example.HelloWorld`
- パブリックコンポーネントは選択しなくても良い。後述するがこれらコンポーネントの活用でログ機能等を

#### 6.5.4.Step3 コンポーネントを設定

- 各コンポーネントに追加設定を行うことができるが、本手順では実施しない

#### 6.5.5.Step4 詳細設定を構成

<!-- それぞれがどのような設定か記述する -->
- ロールアウト設定：
- タイムアウト設定：
- キャンセル設定：
- デプロイポリシー：

#### 6.5.6.Step5 レビュー

- 問題なければデプロイをクリック

### 6.6.動作確認

- ここまでの作業でEdgeデバイスに作成した`com.example.HelloWorld`がアップロードされデバイスで動作する

Edgeデバイス(RaspberryPi)で以下のコマンドにより動作確認を行うことができる

```sh
sudo tail -f /greengrass/v2/logs/[コンポーネント名].log
# 入力例 sudo tail -f /greengrass/v2/logs/com.example.HelloWorld.log
# 出力例 Hello, world!
```

### 7.恩恵

- AWSからEdgeデバイスまでのプログラムのデプロイメントは物理的な接続無しに実施出来る（OTA機能）
- プログラム管理をS3を含めたCloudで強制することで、野良ブランチを排除し管理を確実にする


---



### 8.ロギング強化

- 前述の実装ではプログラムの管理はましになったもののデバイスのロギングがまだ弱い状態です。
- 基本的なロギング設定を以下に記します

:::details デプロイする想定コード

```python
import logging
import sys
import time
from datetime import datetime
from zoneinfo import ZoneInfo
class JstIsoFormatter(logging.Formatter):
    """asctime を JST ISO8601 にする"""
    def formatTime(self, record, datefmt=None):
        dt = datetime.fromtimestamp(record.created, ZoneInfo("Asia/Tokyo"))
        return dt.strftime("%Y-%m-%dT%H:%M:%S.%f") + dt.strftime("%z")

def configure_logger(name: str = "com.example.HelloWorld") -> logging.Logger:
    root = logging.getLogger()
    root.handlers.clear()
    logger = logging.getLogger(name)
    logger.handlers.clear()
    logging.lastResort = None
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(logging.DEBUG)
    fmt = "%(asctime)s - (%(filename)s:%(lineno)d) - [%(levelname)s] - %(message)s"
    handler.setFormatter(JstIsoFormatter(fmt=fmt))
    logger.addHandler(handler)
    logger.setLevel(logging.DEBUG)
    logger.propagate = False
    return logger

logger = configure_logger()
logger.debug("デバッグログです。")
logger.info("通常のログです。")
logger.warning("警告です。")
logger.error("エラー発生です。")
logger.critical("緊急事態です。")
```
:::

#### 8.1.変更項目

aws.greengrass.LogManager

```json
{
    "logsUploaderConfiguration": {
        "systemLogsConfiguration": {
          "uploadToCloudWatch": "true",
          "minimumLogLevel": "DEBUG"
        },
        "componentLogsConfigurationMap": {
            "com.example.HelloWorld": {
                "minimumLogLevel": "DEBUG"
            }
        }
      },
    "periodicUploadIntervalSec": 5,
    "deprecatedVersionSupport": false
}
```

aws.greengrass.Nucleus

```json
{
  "logging": {
      "level": "DEBUG",
      "format": "JSON"
  }
}
```

ログのリアルタイム性が重要なシステムでは必要に応じレシピの `Manifests.Lifecycle.run`を`python3 -u {artifacts:path}/hello_world.py {configuration:/Message}`のように`-u`オプションをつける変更を行う~~とよいとAIから聞いた~~

https://docs.python.org/ja/3/using/cmdline.html#cmdoption-u

#### 8.2.動作確認

上記変更をデプロイ完了した後に以下のログが確認できます

CloudWatchのロググループ`/aws/greengrass/UserComponent/ap-northeast-1/{Component name}`

```json
{
    "thread": "Copier",
    "level": "INFO",
    "eventType": "stdout",
    "message": "2026-01-14T09:53:04.469+0900 - (hello_world.py:49) - [DEBUG] - ロガーで取得したデバッグログです。",
    "contexts": {
        "scriptName": "services.com.example.HelloWorld.lifecycle.run",
        "serviceName": "com.example.HelloWorld",
        "currentState": "RUNNING"
    },
    "loggerName": "com.example.HelloWorld",
    "timestamp": 1768351984469,
    "cause": null
}
```

![cloudwatchlog](/images/greengrass/cloudwatch_log.png)

トップレベルの`level`がINFOになってしまう点は生成AIに聞いても変更のコストが高かったのでここまでとしました

#### 8.3.本番環境でのログについて

- PoCレベルでは上記程度のログで問題ないと考えました。
- 実運用では、ログのフィルタリングだけをとってもQueryが複雑化してしまい理想的ではないと思います
- より開発にあったログをコントロールするためにいくつか使えそうなコンポーネントをいくつか列挙します

##### aws.greengrass.Nucleus

```json
{
  "mqttTopic": "topic name", // telemetry dataを自動取得し自動PubするTopicの指定
  "telemetryPublishIntervalMs": 60000  // telemetry dataを Pubする間隔（ミリ秒単位）
}
```

telemetryで取得できる情報には以下のようなものが存在します

| 名前                       | 説明                                                                                 |
| -------------------------- | ------------------------------------------------------------------------------------ |
| CpuUsage                   | Greengrassコアデバイス上のすべてのアプリケーションによって現在使用されているCPU量    |
| SYstemMemUsage             | Greengrassコアデバイス上のすべてのアプリケーションによって現在使用されているメモリ量 |
| NumberOfComponentsStarting | Greengrassコアデバイス上で起動しているコンポポーネンの数                         |

